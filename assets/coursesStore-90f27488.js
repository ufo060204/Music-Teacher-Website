import{d as f}from"./pinia-ef994b1a.js";import{S as u}from"./userStore-c0c23e47.js";import{g as A,n as d,h as g,e as h,d as m,u as y}from"./index.browser.esm2017-40166462.js";import{t as I}from"./teacherStore-85010782.js";const i=A(),p=I(),C=u.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:1500,timerProgressBar:!0,didOpen:e=>{e.addEventListener("mouseenter",u.stopTimer),e.addEventListener("mouseleave",u.resumeTimer)}}),L=f("coursesStore",{state:()=>({isLoading:!0,AllCourseData:[],teacherNames:{},courseDetails:{data:{}},courseViewDetails:{data:{buyer:[],classMode:[],courseId:"",courseImg:"",courseIntro:"",location:"",name:"",price:0,startTime:0,teacherId:{},teacherImg:"",time:0,type:""},teacherImg:"",teacherName:"",teacherUid:""},popularCourses:[],suggestCourses:[]}),actions:{async getAllCourses(){const e=await d(g(i,"AllCourses"));this.AllCourseData=[],console.log("querySnapshot,",e),e.forEach(s=>{console.log(s.id," => ",s.data());const t={id:s.id,createdTime:s._document.createTime.timestamp.seconds,data:s.data()};this.AllCourseData.push(t)}),console.log("所有課程資料",this.AllCourseData)},async getAllCoursesAndTeacher(){this.isLoading=!0,this.AllCourseData=[];const e=await d(g(i,"AllCourses")),s=[];e.forEach(t=>{const a=t.data();console.log("這是 courseData",a);const c=a.teacherId;console.log("這是 teacherId",c);const o=h(c).then(r=>{if(r.exists()){const l=r.data().displayName;a.teacherName=l,this.teacherNames[a.teacherId]=l}else console.log(`老師 document ${a.teacherId} 不存在`)}).catch(r=>{console.error("老師 document fetching 錯誤",r)});s.push(o);const n={id:t.courseId,data:a};this.AllCourseData.push(n)}),await Promise.all(s),console.log("所有課程數據",this.AllCourseData),console.log("老師名稱",this.teacherNames),this.isLoading=!1},getBuyerCount(e){return e.data.buyer.length},async getPopularCourses(){this.popularCourses=[],await this.getAllCoursesAndTeacher(),console.log("購買人數排序前 - 購買人數",this.AllCourseData.map(e=>e.data.buyer.length)),console.log("購買人數排序前 - 課程名稱",this.AllCourseData.map(e=>e.data.name)),this.AllCourseData.sort((e,s)=>s.data.buyer.length-e.data.buyer.length),console.log("購買人數排序後 - 購買人數",this.AllCourseData.map(e=>e.data.buyer.length)),console.log("購買人數排序後 - 課程名稱",this.AllCourseData.map(e=>e.data.name)),this.popularCourses=this.AllCourseData.slice(0,10),console.log("暢銷課程前 10 名",this.popularCourses)},async getSuggestCourses(){this.isLoading=!0,this.suggestCourses=[],await this.getAllCoursesAndTeacher();const e=[];this.AllCourseData.forEach(t=>{t.data.type===this.courseDetails.data.type&&e.push(t)});const s=e.sort(()=>.5-Math.random());this.suggestCourses=s.slice(0,3),console.log("推薦課程",this.suggestCourses),this.isLoading=!1},async getCourseDetails(e){this.isLoading=!0;const s=m(i,"AllCourses",e),t=await h(s);if(console.log("store 的",t),console.log("store 的 courseId",e),t.exists()){const a=t.data(),c=a.teacherId,o=await h(c);if(o.exists()){const n=o.data().displayName,r=o.data().userIntro,l=o.data().userPhoto,D=o.data().uid;this.courseDetails={data:a,teacherName:n,teacherIntro:r,teacherImg:l,teacherUid:D},this.courseViewDetails=JSON.parse(JSON.stringify(this.courseDetails))}else console.log(`老師 document ${c.path} 不存在`)}else console.log(`課程 document ${e} 不存在`);console.log("單一課程資料",this.courseDetails),this.isLoading=!1},async updateCourseData(e){this.courseDetails.data.courseImg=p.teacherData.courseImg,await y(m(i,"AllCourses",e),this.courseDetails.data);try{p.teacherData.courseImg="",console.log("課程資料更新成功"),this.getCourseDetails(e),C.fire({icon:"success",title:"課程資料更新成功"})}catch(s){console.log("課程資料更新失敗",s),C.fire({icon:"error",title:"課程資料更新失敗"})}}},getters:{}});export{L as c};
