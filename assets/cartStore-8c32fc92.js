import{d as g}from"./pinia-ef994b1a.js";import{g as C,a as m,o as p,d as c,u as a,b as u,c as w,e as d,f as y,h as S,i as T}from"./index.browser.esm2017-ac27ce2e.js";import{a as D}from"./index.esm2017-880666f6.js";import{u as F,S as i}from"./userStore-2f73dc30.js";const R=F(),r=C(),l=i.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:1500,timerProgressBar:!0,didOpen:e=>{e.addEventListener("mouseenter",i.stopTimer),e.addEventListener("mouseleave",i.resumeTimer)}}),L=g("cartStore",{state:()=>({isMember:!1,cart:[],selectedCourseIds:[],selectedCourses:[],selectedCoursesFinal:[],uid:"",total:0,isEditMode:!1,isSelectedCoursesAll:!1,orderTime:0,isLoading:!0,isCouponCode:!1,useCoupon:!1,couponCode:"",cartStatus:"cart"}),actions:{async getUid(){return new Promise((e,o)=>{const t=m();p(t,s=>{s?(console.log("這是使用者內容",s),this.uid=s.uid,console.log("這是 uid",this.uid),e(this.uid)):s?o(new Error("用戶未經身份驗證 User not authenticated")):console.log("你是登出狀態")})})},async addToCart(e){if(!R.isMember){i.fire({icon:"info",title:"請先登入",confirmButtonColor:"#FE715F"});return}await this.getUid();const o=c(r,"AllCourses",e),t=c(r,"users",this.uid);if(this.cart.some(s=>s.courseId===e)){console.log("課程已在購物車中"),l.fire({icon:"info",title:"課程已在購物車中"});return}await a(t,{cart:u(o)},{merge:!0});try{this.getCart(),console.log("加入購物車成功"),l.fire({icon:"success",title:"加入購物車成功"})}catch(s){console.log("加入購物車失敗",s),l.fire({icon:"error",title:"加入購物車失敗"})}},async removeFromCollection(e){await this.getUid();const o=c(r,"AllCourses",e),t=c(r,"users",this.uid);await a(t,{cart:w(o)},{merge:!0});try{this.getCart(),console.log("從購物車移除成功"),l.fire({icon:"success",title:"從購物車移除成功"})}catch(s){console.log("從購物車移除失敗",s),l.fire({icon:"error",title:"從購物車移除失敗"})}},async getCart(){try{this.isLoading=!0;const e=await this.getUid(),o=c(r,"users",e),t=await d(o);if(t.exists()){const s=t.get("cart");console.log("購物車參考",s);const h=s.map(f=>d(f)),n=await Promise.all(h);this.cart=n.map(f=>f.data()),console.log("購物車內容",this.cart),this.isLoading=!1}else console.log("User document does not exist."),this.cart=[],this.isLoading=!1}catch(e){console.error("購物車內容錯誤:",e),this.isLoading=!1}},checkAllCourses(){console.log(this.isSelectedCoursesAll),this.isSelectedCoursesAll?(this.selectedCourses=[],this.selectedCourseIds=[]):this.cart.forEach(e=>{this.selectedCourses.push(e),this.selectedCourseIds.push(e.courseId),console.log(this.selectedCourses),console.log(this.selectedCourseIds)})},async checkout(){const e=c(r,"users",this.uid),o=await d(e);if(this.orderTime=Date.now(),o.exists()){console.log("購物車內容(更新後)",this.selectedCoursesFinal);const t=await y(S(r,"orders"),{orderDetail:this.selectedCoursesFinal,createdTime:this.orderTime,user:this.uid,total:this.selectedCoursesTotal,couponTotal:this.couponTotal,useCoupon:this.useCoupon});console.log("訂購的時間",this.orderTime),console.log("要送出的訂單檔案",t),console.log("要送出的訂單檔案 id",t.id),this.selectedCoursesFinal.forEach(async s=>{await a(e,{courses_joined:u(s)},{merge:!0}),await a(s,{buyer:u(this.uid)},{merge:!0})}),await a(e,{myOrders:u(t.id)},{merge:!0}),await a(e,{cart:T()}),await a(e,{cart:[]}),console.log("結帳成功, 參加課程追加成功"),this.cart=[],this.cartStatus="cart",this.total=0,D.push("/orderFinished"),i.fire({title:"結帳成功",icon:"success"})}},copyCouponCode(e){navigator.clipboard.writeText(e).then(()=>{this.couponCode=e,console.log("優惠碼",e),alert("優惠碼複製成功"),l.fire({icon:"success",title:"優惠碼複製成功"})})},addCouponCode(e){e==="888"?(this.isCouponCode=!0,this.useCoupon=!0,i.fire({title:"優惠碼加入成功",icon:"success"})):i.fire({title:"優惠碼不存在",icon:"warning"})},async goCheckout(){this.selectedCourseIds.length!==0?(this.cartStatus="checkout",this.filterSelect()):i.fire({title:"請先勾選要結帳的項目",confirmButtonColor:"#FE715F"})},goBackCart(){this.cartStatus="cart"},async filterSelect(){const e=c(r,"users",this.uid),o=await d(e);if(o.exists()){const t=o.get("cart");console.log("購物車參考",t);const s=t.filter(h=>{const n=h.id;return console.log("cart課程參考當中的 id",n),this.selectedCourseIds.includes(n)});this.selectedCoursesFinal=s,console.log("篩選後的參考",s),console.log("最後要加入訂單的參考",this.selectedCoursesFinal)}else console.log("User document does not exist.")}},getters:{selectedCoursesTotal(){let e=0;return this.selectedCourses.forEach(o=>{e+=parseInt(o.price)}),e},couponTotal(){return this.selectedCoursesTotal*.8}}});export{L as c};
