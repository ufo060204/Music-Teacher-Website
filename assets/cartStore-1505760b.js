import{d as m}from"./pinia-ef994b1a.js";import{g as p,S as a,a as w,o as y,d as i,u as c,b as h,c as T,e as l,f as S,h as C,s as g,i as D}from"./sweetalert2.all-9399aa4b.js";import{b as F}from"./index.esm2017-92c3af99.js";import{u as R}from"./userStore-acfd5be5.js";const I=R(),r=p(),n=a.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:1500,timerProgressBar:!0,didOpen:e=>{e.addEventListener("mouseenter",a.stopTimer),e.addEventListener("mouseleave",a.resumeTimer)}}),L=m("cartStore",{state:()=>({isMember:!1,cart:[],selectedCourseIds:[],selectedCourses:[],selectedCoursesFinal:[],uid:"",total:0,isEditMode:!1,isSelectedCoursesAll:!1,orderTime:0,isLoading:!0,isCouponCode:!1,useCoupon:!1,couponCode:"",cartStatus:"cart"}),actions:{async getUid(){return new Promise((e,o)=>{const s=w();y(s,t=>{t?(console.log("這是使用者內容",t),this.uid=t.uid,console.log("這是 uid",this.uid),e(this.uid)):t?o(new Error("用戶未經身份驗證 User not authenticated")):console.log("你是登出狀態")})})},async addToCart(e){if(!I.isMember){a.fire({icon:"info",title:"請先登入",confirmButtonColor:"#FE715F"});return}await this.getUid();const o=i(r,"AllCourses",e),s=i(r,"users",this.uid);if(this.cart.some(t=>t.courseId===e)){console.log("課程已在購物車中"),n.fire({icon:"info",title:"課程已在購物車中"});return}await c(s,{cart:h(o)},{merge:!0});try{this.getCart(),console.log("加入購物車成功"),n.fire({icon:"success",title:"加入購物車成功"})}catch(t){console.log("加入購物車失敗",t),n.fire({icon:"error",title:"加入購物車失敗"})}},async removeFromCollection(e){await this.getUid();const o=i(r,"AllCourses",e),s=i(r,"users",this.uid);await c(s,{cart:T(o)},{merge:!0});try{this.getCart(),console.log("從購物車移除成功"),n.fire({icon:"success",title:"從購物車移除成功"})}catch(t){console.log("從購物車移除失敗",t),n.fire({icon:"error",title:"從購物車移除失敗"})}},async getCart(){try{this.isLoading=!0;const e=await this.getUid(),o=i(r,"users",e),s=await l(o);if(s.exists()){const t=s.get("cart");console.log("購物車參考",t);const u=t.map(f=>l(f)),d=await Promise.all(u);this.cart=d.map(f=>f.data()),console.log("購物車內容",this.cart),this.isLoading=!1}else console.log("User document does not exist."),this.cart=[],this.isLoading=!1}catch(e){console.error("購物車內容錯誤:",e),this.isLoading=!1}},checkAllCourses(){console.log(this.isSelectedCoursesAll),this.isSelectedCoursesAll?(this.selectedCourses=[],this.selectedCourseIds=[]):this.cart.forEach(e=>{this.selectedCourses.push(e),this.selectedCourseIds.push(e.courseId),console.log(this.selectedCourses),console.log(this.selectedCourseIds)})},async checkout(){const e=i(r,"users",this.uid),o=await l(e);if(this.orderTime=Date.now(),o.exists()){console.log("購物車內容(更新後)",this.selectedCoursesFinal);const s=await S(C(r,"orders"),{orderDetail:this.selectedCoursesFinal,createdTime:this.orderTime,user:this.uid,total:this.selectedCoursesTotal,couponTotal:this.couponTotal,useCoupon:this.useCoupon});console.log("訂購的時間",this.orderTime),console.log("要送出的訂單檔案",s),console.log("要送出的訂單檔案 id",s.id),await c(s,{orderId:s.id}),this.selectedCoursesFinal.forEach(async t=>{await c(e,{courses_joined:h(t)},{merge:!0}),await c(t,{buyer:h(this.uid)},{merge:!0});const u=C(r,"AllCourses",(await l(t)).data().courseId,"buyerStudyTime");await g(i(u,this.uid),{createdTime:this.orderTime})}),await c(e,{myOrders:h(s.id)},{merge:!0}),await c(e,{cart:D()}),await c(e,{cart:[]}),console.log("結帳成功, 參加課程追加成功"),this.cart=[],this.cartStatus="cart",this.total=0,F.push("/orderFinished"),a.fire({title:"結帳成功",icon:"success"})}},refTest(){const e=[];this.selectedCoursesFinal.forEach(async o=>{e.push((await l(o)).data());const s=C(r,"AllCourses",(await l(o)).data().courseId,"buyerStudyTime");await g(i(s,"uid"),{createdTime:1695314902799}),console.log("buyerStudyTimeCollectionRef 設置成功",s)}),console.log("refTest",e)},copyCouponCode(e){navigator.clipboard.writeText(e).then(()=>{this.couponCode=e,console.log("優惠碼",e),alert("優惠碼複製成功"),n.fire({icon:"success",title:"優惠碼複製成功"})})},addCouponCode(e){e==="888"?(this.isCouponCode=!0,this.useCoupon=!0,a.fire({title:"優惠碼加入成功",icon:"success"})):a.fire({title:"優惠碼不存在",icon:"warning"})},async goCheckout(){this.selectedCourseIds.length!==0?(this.cartStatus="checkout",this.filterSelect()):a.fire({title:"請先勾選要結帳的項目",confirmButtonColor:"#FE715F"})},goBackCart(){this.cartStatus="cart"},async filterSelect(){const e=i(r,"users",this.uid),o=await l(e);if(o.exists()){const s=o.get("cart");console.log("購物車參考",s);const t=s.filter(u=>{const d=u.id;return console.log("cart課程參考當中的 id",d),this.selectedCourseIds.includes(d)});this.selectedCoursesFinal=t,console.log("篩選後的參考",t),console.log("最後要加入訂單的參考",this.selectedCoursesFinal)}else console.log("User document does not exist.")}},getters:{selectedCoursesTotal(){let e=0;return this.selectedCourses.forEach(o=>{e+=parseInt(o.price)}),e},couponTotal(){return this.selectedCoursesTotal*.8}}});export{L as c};
