import{d as U}from"./pinia-ef994b1a.js";import{b as f}from"./index.esm2017-edf80b13.js";import{g as A,G as B,S as c,a as d,j as M,k,d as n,s as g,l as I,m as P,o as b,e as l,u as h,b as R,c as v,h as D,q as w,n as p}from"./sweetalert2.all-4c085619.js";import{m as C}from"./moment-8cce7dfb.js";const r=A(),E=new B,u=c.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:1500,timerProgressBar:!0,didOpen:t=>{t.addEventListener("mouseenter",c.stopTimer),t.addEventListener("mouseleave",c.resumeTimer)}}),q=U("usersStore",{state:()=>({singUpData:{email:"",password:""},loginUser:{email:"",password:""},userData:{uid:"",userPhoto:"",userBackgroundPhoto:"",displayName:"",email:"",tel:"",gender:"",facebook:"",instagrm:"",discord:"",birthday:"",address:"",story:"",userIntro:"",creationTime:"",lastSignInTime:"",myOrders:[],courses_created:[],courses_joined:[],coursesCollection:[],cart:[]},userDataAll:{},personalViewData:{},coursesJoined:[],coursesCreated:[],coursesCollection:[],coursesCollectionId:[],isLoading:!0,isLogin:!0,isMember:!1,uid:"",isEditMode:!1,updateNameStatus:!1,updateStoryStatus:!1,buyerStudyTimeData:[],myStudyTimeData:[],updateBuyerStudyTimeUid:"",updateBuyerStudyTimeCourseId:"",buyerStudyTime:"",buyerStudyTimeAll:[]}),actions:{signUp(){const t=d();M(t,this.singUpData.email,this.singUpData.password).then(e=>{this.userData.uid=e.user.uid,this.userData.email=e.user.email,this.setUserData(),this.checkMemberObserver(),this.singUpData.email="",this.singUpData.password="",this.singUpData.confirmation="",this.userData.displayName="",c.fire({icon:"success",title:"恭喜註冊成功",showConfirmButton:!1,timer:1500}),f.push("/")}).catch(e=>{e.code==="auth/email-already-in-use"?c.fire({icon:"error",title:"你註冊失敗了",text:"此 email 已被使用過",confirmButtonColor:"#FE715F"}):c.fire({icon:"error",title:"你註冊失敗了",confirmButtonColor:"#FE715F"})})},login(){const t=d();k(t,this.loginUser.email,this.loginUser.password).then(e=>{const s=n(r,"users",e.user.uid);g(s,{lastSignInTime:e.user.metadata.lastSignInTime},{merge:!0}),this.isMember=!0,this.loginUser.email="",this.loginUser.password="",c.fire({icon:"success",title:"登入成功",showConfirmButton:!1,timer:1500}),f.push("/")}).catch(e=>{e.code==="auth/user-not-found"?c.fire({icon:"error",title:"登入失敗，使用者不存在",showConfirmButton:!1,timer:1500}):e.code==="auth/wrong-password"?c.fire({icon:"error",title:"登入失敗，密碼錯誤",showConfirmButton:!1,timer:1500}):e.code==="auth/too-many-requests"?c.fire({icon:"error",title:"嘗試次數過多，請稍後在試",showConfirmButton:!1,timer:1500}):c.fire({icon:"error",title:"登入失敗",showConfirmButton:!1,timer:1500})})},loginGoogle(){const t=d();I(t,E).then(e=>{if(this.isMember=!0,e.user.metadata.creationTime===e.user.metadata.lastSignInTime)this.userData.uid=e.user.uid,this.userData.email=e.user.email,this.userData.creationTime=e.user.metadata.creationTime,this.userData.lastSignInTime=e.user.metadata.lastSignInTime,this.setUserData();else{const s=n(r,"users",e.user.uid);g(s,{lastSignInTime:e.user.metadata.lastSignInTime},{merge:!0})}f.push("/"),this.getUserDataAll(),u.fire({icon:"success",title:"使用google登入成功"})}).catch(e=>{u.fire({icon:"error",title:`使用 google 登入失敗 ${e.message}`})})},signOut(){const t=d();P(t).then(e=>{this.isMember=!1,this.userData.displayName="",this.userData.uid="",this.userData.userPhoto="",this.userData.userBackgroundPhoto="",this.userData.email="",this.userData.tel="",this.userData.gender="",this.userData.facebook="",this.userData.instagrm="",this.userData.discord="",this.userData.birthday="",this.userData.address="",this.userData.story="",this.userData.userIntro="",this.userData.creationTime="",this.userData.lastSignInTime="",this.userData.myOrders=[],this.userData.courses_created=[],this.userData.courses_joined=[],this.userData.coursesCollection=[],this.userData.cart=[],this.checkMemberObserver(),u.fire({icon:"success",title:"登出成功"})}).catch(e=>{u.fire({icon:"warning",title:`登出錯誤 ${e}`})})},async setUserData(){try{await g(n(r,"users",this.userData.uid),this.userData),u.fire({icon:"success",title:"課程會員新增資料成功"})}catch(t){u.fire({icon:"error",title:`課程會員資料新增失敗 ${t}`})}},async checkMemberObserver(){return this.personalViewData={},new Promise((t,e)=>{const s=d();b(s,a=>{a?(this.isMember=!0,this.uid=a.uid,t(this.uid),this.getUserDataAll()):a?(e(new Error("你是登出狀態")),this.isMember=!1):this.isMember=!1})})},checkMemberTeacherStep(){const t=d();b(t,e=>{e||(f.push("/login"),c.fire({icon:"info",title:"請先登入",confirmButtonColor:"#FE715F"}))})},async getUserDataAll(){try{const t=n(r,"users",this.uid),e=await l(t);e.exists()?(this.userData=e.data(),this.personalViewData={...this.userData}):console.log("No such document!")}catch(t){console.log(t)}},async updateUserData(){await h(n(r,"users",this.userData.uid),this.userData);try{this.isEditMode=!1,this.getUserDataAll(),u.fire({icon:"success",title:"會員資料更新成功"})}catch(t){u.fire({icon:`error ${t}`,title:"會員資料更新失敗"})}},async updateUserPhoto(t,e){try{const s=e.target.files[0];if(!s||!(await this.beforeUpdate(s)).isValid)return;this.imgHandle(t,s)}catch(s){console.log(s)}finally{e.target.value=null}},beforeUpdate(t){return new Promise(e=>{const a=["image/jpeg","image/png"].includes(t.type),i=t.size/1024/1024<.15;a?i||c.fire({icon:"error",title:"尺寸錯誤",text:"圖片大小需小於 0.15 MB"}):c.fire({icon:"error",title:"格式錯誤",text:"請上傳 JPG 或 PNG 檔"}),e({isValid:a&&i})})},imgHandle(t,e){const s=new FormData;s.append("photoFile",e);const a=s.get("photoFile"),i=new FileReader;i.readAsDataURL(a),i.onload=o=>{t==="course"?(this.teacherData.courseImg=o.target.result,u.fire({icon:"success",title:"課程圖片更新成功"})):t==="teacher"?(this.userData.userPhoto=o.target.result,h(n(r,"users",this.userData.uid),this.userData),u.fire({icon:"success",title:"使用者圖片更新成功"})):t==="background"&&(this.userData.userBackgroundPhoto=o.target.result,h(n(r,"users",this.userData.uid),this.userData),u.fire({icon:"success",title:"背景圖片更新成功"}))}},async getUserAllCreated(){await this.checkMemberObserver();const t=n(r,"users",this.uid);l(t).then(e=>{if(e.exists()){const s=e.get("courses_created"),a=[];return s.forEach(i=>{a.push(l(i))}),Promise.all(a)}else return console.log("使用者 document 不存在(老師)"),[]}).then(e=>{this.coursesCreated=e.map(s=>s.data())}).catch(e=>{console.err("沒有符合的開課:",e)})},async addToCollection(t){if(!this.isMember){c.fire({icon:"info",title:"請先登入",confirmButtonColor:"#FE715F"});return}const e=n(r,"AllCourses",t),s=n(r,"users",this.userData.uid);await h(s,{coursesCollection:R(e)},{merge:!0});try{this.getUserAllCollection(),u.fire({icon:"success",title:"加入收藏成功"})}catch(a){u.fire({icon:"error",title:`加入收藏失敗 ${a}`})}},async removeFromCollection(t){const e=n(r,"AllCourses",t),s=n(r,"users",this.userData.uid);await h(s,{coursesCollection:v(e)},{merge:!0});try{this.getUserAllCollection(),u.fire({icon:"success",title:"移除收藏成功"})}catch(a){u.fire({icon:`error ${a}`,title:"移除收藏失敗"})}},async getUserAllCollection(){await this.checkMemberObserver();const t=n(r,"users",this.uid);l(t).then(e=>{if(e.exists()){const s=e.get("coursesCollection"),a=[];return s.forEach(i=>{a.push(l(i))}),Promise.all(a)}else console.log("使用者 document 不存在(收藏)")}).then(async e=>{this.coursesCollection=await Promise.all(e.map(async s=>{const a=s.data(),i=s.data().teacherId,o=await this.getTeacherDisplayName(i);return{...a,teacherDisplayName:o}})),this.coursesCollectionId=e.map(s=>s.data().courseId)}).catch(e=>{console.err("沒有符合的收藏:",e)})},async getUserAllJoin(){this.isLoading=!0,await this.checkMemberObserver();const t=n(r,"users",this.uid);l(t).then(e=>{if(e.exists()){const s=e.get("courses_joined"),a=[];return s.forEach(i=>{a.push(l(i))}),Promise.all(a)}else console.log("使用者 document 不存在(收藏)")}).then(async e=>{this.coursesJoined=await Promise.all(e.map(async s=>{const a=s.data(),i=s.data().teacherId,o=await this.getTeacherDisplayName(i);return{...a,teacherDisplayName:o}})),this.isLoading=!1}).catch(e=>{console.err("沒有符合的課程:",e)})},async getTeacherDisplayName(t){try{const e=await l(t);return e.exists()&&e.data().displayName||"Unknown Teacher"}catch(e){return console.err("獲取老師資料失敗",e),"Unknown Teacher"}},toggleCollection(t){this.coursesCollectionId.indexOf(t)>-1?this.removeFromCollection(t):this.addToCollection(t)},async getBuyer(t){const e=D(r,"AllCourses",t,"buyerStudyTime"),s=w(e);(await p(s)).forEach(async i=>{const o={},m=n(r,"users",i.id),S=(await l(m)).data();o.uid=i.id,o.courseId=t,o.studyTime=i.data().studyTime,o.createdTime=i.data().createdTime,o.displayName=S.displayName,this.buyerStudyTimeData.push(o)})},async getMyStudyTime(t){await this.checkMemberObserver();const e=D(r,"AllCourses",t,"buyerStudyTime"),s=w(e);(await p(s)).forEach(async i=>{i.id===this.uid&&this.myStudyTimeData.push(i.data())})},closeBuyTimeModal(){this.buyerStudyTimeData=[],this.myStudyTimeData=[]},beforeUpdateBuyerStudyTime(t,e){this.updateBuyerStudyTimeCourseId=t,this.updateBuyerStudyTimeUid=e},async updateBuyerStudyTime(){console.log(this.buyerStudyTimeData);const t=n(r,"AllCourses",this.updateBuyerStudyTimeCourseId,"buyerStudyTime",this.updateBuyerStudyTimeUid);try{await h(t,{studyTime:this.buyerStudyTime}),this.buyerStudyTimeData=[],u.fire({icon:"success",title:"上課時間更新成功"})}catch(e){u.fire({icon:"error",title:`上課時間更新失敗 ${e}`})}},async getUserAllJoinStudyTime(){this.buyerStudyTimeAll=[],await this.checkMemberObserver();const t=n(r,"users",this.uid);l(t).then(async e=>{e.exists()?(await e.get("courses_joined")).map(async a=>{const i={},o=await l(a);i.title=o.data().name;const m=a.id;i.courseId=m;const T=D(r,"AllCourses",m,"buyerStudyTime");(await p(T)).forEach(async y=>{y.id===this.uid&&y.data().studyTime&&(i.start=C(y.data().studyTime).format("YYYY-MM-DD HH:mm"),i.end=C(y.data().studyTime).add(o.data().time,"minute").format("YYYY-MM-DD HH:mm"))}),this.buyerStudyTimeAll.push(i)}):console.log("使用者 document 不存在(收藏)")}).catch(e=>{console.err("取得使用者文檔出錯:",e)})}},getters:{collectionStatus(){return this.getUserAllCollection(),t=>this.coursesCollectionId.indexOf(t)>-1?"bookmark":"bookmark_border"}}});export{q as u};
