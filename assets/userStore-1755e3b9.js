import{d as U}from"./pinia-ef994b1a.js";import{b as y}from"./index.esm2017-f9f20be6.js";import{g as A,G as B,S as u,a as d,j as M,k,d as n,s as g,l as I,m as P,o as b,e as l,u as h,b as R,c as E,h as p,q as w,n as D}from"./sweetalert2.all-18387a7d.js";import{m as C}from"./moment-1efe58f9.js";const a=A(),v=new B,c=u.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:1500,timerProgressBar:!0,didOpen:t=>{t.addEventListener("mouseenter",u.stopTimer),t.addEventListener("mouseleave",u.resumeTimer)}}),q=U("usersStore",{state:()=>({singUpData:{email:"",password:""},loginUser:{email:"",password:""},userData:{uid:"",userPhoto:"",userBackgroundPhoto:"",displayName:"",email:"",tel:"",gender:"",facebook:"",instagrm:"",discord:"",birthday:"",address:"",story:"",userIntro:"",creationTime:"",lastSignInTime:"",myOrders:[],courses_created:[],courses_joined:[],coursesCollection:[],cart:[]},userDataAll:{},personalViewData:{},coursesJoined:[],coursesCreated:[],coursesCollection:[],coursesCollectionId:[],isLoading:!0,isLogin:!0,isMember:!1,uid:"",isEditMode:!1,updateNameStatus:!1,updateStoryStatus:!1,buyerStudyTimeData:[],myStudyTimeData:[],updateBuyerStudyTimeUid:"",updateBuyerStudyTimeCourseId:"",buyerStudyTime:"",buyerStudyTimeAll:[]}),actions:{signUp(){const t=d();M(t,this.singUpData.email,this.singUpData.password).then(e=>{this.userData.uid=e.user.uid,this.userData.email=e.user.email,this.setUserData(),this.checkMemberObserver(),this.singUpData.email="",this.singUpData.password="",u.fire({icon:"success",title:"恭喜註冊成功",showConfirmButton:!1,timer:1500}),y.push("/")}).catch(e=>{e.code==="auth/email-already-in-use"?u.fire({icon:"error",title:"你註冊失敗了",text:"此 email 已被使用過",confirmButtonColor:"#FE715F"}):u.fire({icon:"error",title:"你註冊失敗了",confirmButtonColor:"#FE715F"})})},login(){const t=d();k(t,this.loginUser.email,this.loginUser.password).then(e=>{const s=n(a,"users",e.user.uid);g(s,{lastSignInTime:e.user.metadata.lastSignInTime},{merge:!0}),this.isMember=!0,this.loginUser.email="",this.loginUser.password="",u.fire({icon:"success",title:"登入成功",showConfirmButton:!1,timer:1500}),y.push("/")}).catch(e=>{e.code==="auth/user-not-found"?u.fire({icon:"error",title:"登入失敗，使用者不存在",showConfirmButton:!1,timer:1500}):e.code==="auth/wrong-password"?u.fire({icon:"error",title:"登入失敗，密碼錯誤",showConfirmButton:!1,timer:1500}):e.code==="auth/too-many-requests"?u.fire({icon:"error",title:"嘗試次數過多，請稍後在試",showConfirmButton:!1,timer:1500}):u.fire({icon:"error",title:"登入失敗",showConfirmButton:!1,timer:1500})})},loginGoogle(){const t=d();I(t,v).then(e=>{if(this.isMember=!0,e.user.metadata.creationTime===e.user.metadata.lastSignInTime)this.userData.uid=e.user.uid,this.userData.email=e.user.email,this.userData.creationTime=e.user.metadata.creationTime,this.userData.lastSignInTime=e.user.metadata.lastSignInTime,this.setUserData();else{const s=n(a,"users",e.user.uid);g(s,{lastSignInTime:e.user.metadata.lastSignInTime},{merge:!0})}y.push("/"),this.getUserDataAll(),c.fire({icon:"success",title:"使用google登入成功"})}).catch(e=>{c.fire({icon:"error",title:`使用 google 登入失敗 ${e.message}`})})},signOut(){const t=d();P(t).then(e=>{this.isMember=!1,c.fire({icon:"success",title:"登出成功"})}).catch(e=>{c.fire({icon:"warning",title:`登出錯誤 ${e}`})})},async setUserData(){try{await g(n(a,"users",this.userData.uid),this.userData),c.fire({icon:"success",title:"課程會員新增資料成功"})}catch(t){c.fire({icon:"error",title:`課程會員資料新增失敗 ${t}`})}},async checkMemberObserver(){return new Promise((t,e)=>{const s=d();b(s,i=>{i?(this.isMember=!0,this.uid=i.uid,t(this.uid),this.getUserDataAll()):i?(e(new Error("你是登出狀態")),this.isMember=!1):this.isMember=!1})})},checkMemberTeacherStep(){const t=d();b(t,e=>{e||(y.push("/login"),u.fire({icon:"info",title:"請先登入",confirmButtonColor:"#FE715F"}))})},async getUserDataAll(){try{const t=n(a,"users",this.uid),e=await l(t);e.exists()?(this.userData=e.data(),this.personalViewData={...this.userData}):console.log("No such document!")}catch(t){console.log(t)}},async updateUserData(){await h(n(a,"users",this.userData.uid),this.userData);try{this.isEditMode=!1,this.getUserDataAll(),c.fire({icon:"success",title:"會員資料更新成功"})}catch(t){c.fire({icon:`error ${t}`,title:"會員資料更新失敗"})}},async updateUserPhoto(t,e){try{const s=e.target.files[0];if(!s||!(await this.beforeUpdate(s)).isValid)return;this.imgHandle(t,s)}catch(s){console.log(s)}finally{e.target.value=null}},beforeUpdate(t){return new Promise(e=>{const i=["image/jpeg","image/png"].includes(t.type),r=t.size/1024/1024<.15;i?r||u.fire({icon:"error",title:"尺寸錯誤",text:"圖片大小需小於 0.15 MB"}):u.fire({icon:"error",title:"格式錯誤",text:"請上傳 JPG 或 PNG 檔"}),e({isValid:i&&r})})},imgHandle(t,e){const s=new FormData;s.append("photoFile",e);const i=s.get("photoFile"),r=new FileReader;r.readAsDataURL(i),r.onload=o=>{t==="course"?(this.teacherData.courseImg=o.target.result,c.fire({icon:"success",title:"課程圖片更新成功"})):t==="teacher"?(this.userData.userPhoto=o.target.result,h(n(a,"users",this.userData.uid),this.userData),c.fire({icon:"success",title:"使用者圖片更新成功"})):t==="background"&&(this.userData.userBackgroundPhoto=o.target.result,h(n(a,"users",this.userData.uid),this.userData),c.fire({icon:"success",title:"背景圖片更新成功"}))}},async getUserAllCreated(){await this.checkMemberObserver();const t=n(a,"users",this.uid);l(t).then(e=>{if(e.exists()){const s=e.get("courses_created"),i=[];return s.forEach(r=>{i.push(l(r))}),Promise.all(i)}else return console.log("使用者 document 不存在(老師)"),[]}).then(e=>{this.coursesCreated=e.map(s=>s.data())}).catch(e=>{console.err("沒有符合的開課:",e)})},async addToCollection(t){if(!this.isMember){u.fire({icon:"info",title:"請先登入",confirmButtonColor:"#FE715F"});return}const e=n(a,"AllCourses",t),s=n(a,"users",this.userData.uid);await h(s,{coursesCollection:R(e)},{merge:!0});try{this.getUserAllCollection(),c.fire({icon:"success",title:"加入收藏成功"})}catch(i){c.fire({icon:"error",title:`加入收藏失敗 ${i}`})}},async removeFromCollection(t){const e=n(a,"AllCourses",t),s=n(a,"users",this.userData.uid);await h(s,{coursesCollection:E(e)},{merge:!0});try{this.getUserAllCollection(),c.fire({icon:"success",title:"移除收藏成功"})}catch(i){c.fire({icon:`error ${i}`,title:"移除收藏失敗"})}},async getUserAllCollection(){await this.checkMemberObserver();const t=n(a,"users",this.uid);l(t).then(e=>{if(e.exists()){const s=e.get("coursesCollection"),i=[];return s.forEach(r=>{i.push(l(r))}),Promise.all(i)}else console.log("使用者 document 不存在(收藏)")}).then(async e=>{this.coursesCollection=await Promise.all(e.map(async s=>{const i=s.data(),r=s.data().teacherId,o=await this.getTeacherDisplayName(r);return{...i,teacherDisplayName:o}})),this.coursesCollectionId=e.map(s=>s.data().courseId)}).catch(e=>{console.err("沒有符合的收藏:",e)})},async getUserAllJoin(){this.isLoading=!0,await this.checkMemberObserver();const t=n(a,"users",this.uid);l(t).then(e=>{if(e.exists()){const s=e.get("courses_joined"),i=[];return s.forEach(r=>{i.push(l(r))}),Promise.all(i)}else console.log("使用者 document 不存在(收藏)")}).then(async e=>{this.coursesJoined=await Promise.all(e.map(async s=>{const i=s.data(),r=s.data().teacherId,o=await this.getTeacherDisplayName(r);return{...i,teacherDisplayName:o}})),this.isLoading=!1}).catch(e=>{console.err("沒有符合的課程:",e)})},async getTeacherDisplayName(t){try{const e=await l(t);return e.exists()&&e.data().displayName||"Unknown Teacher"}catch(e){return console.err("獲取老師資料失敗",e),"Unknown Teacher"}},toggleCollection(t){this.coursesCollectionId.indexOf(t)>-1?this.removeFromCollection(t):this.addToCollection(t)},async getBuyer(t){const e=p(a,"AllCourses",t,"buyerStudyTime"),s=w(e);(await D(s)).forEach(async r=>{const o={},m=n(a,"users",r.id),S=(await l(m)).data();o.uid=r.id,o.courseId=t,o.studyTime=r.data().studyTime,o.createdTime=r.data().createdTime,o.displayName=S.displayName,this.buyerStudyTimeData.push(o)})},async getMyStudyTime(t){await this.checkMemberObserver();const e=p(a,"AllCourses",t,"buyerStudyTime"),s=w(e);(await D(s)).forEach(async r=>{r.id===this.uid&&this.myStudyTimeData.push(r.data())})},closeBuyTimeModal(){this.buyerStudyTimeData=[],this.myStudyTimeData=[]},beforeUpdateBuyerStudyTime(t,e){this.updateBuyerStudyTimeCourseId=t,this.updateBuyerStudyTimeUid=e},async updateBuyerStudyTime(){console.log(this.buyerStudyTimeData);const t=n(a,"AllCourses",this.updateBuyerStudyTimeCourseId,"buyerStudyTime",this.updateBuyerStudyTimeUid);try{await h(t,{studyTime:this.buyerStudyTime}),this.buyerStudyTimeData=[],c.fire({icon:"success",title:"上課時間更新成功"})}catch(e){c.fire({icon:"error",title:`上課時間更新失敗 ${e}`})}},async getUserAllJoinStudyTime(){this.buyerStudyTimeAll=[],await this.checkMemberObserver();const t=n(a,"users",this.uid);l(t).then(async e=>{e.exists()?(await e.get("courses_joined")).map(async i=>{const r={},o=await l(i);r.title=o.data().name;const m=i.id;r.courseId=m;const T=p(a,"AllCourses",m,"buyerStudyTime");(await D(T)).forEach(async f=>{f.id===this.uid&&f.data().studyTime&&(r.start=C(f.data().studyTime).format("YYYY-MM-DD HH:mm"),r.end=C(f.data().studyTime).add(o.data().time,"minute").format("YYYY-MM-DD HH:mm"))}),this.buyerStudyTimeAll.push(r)}):console.log("使用者 document 不存在(收藏)")}).catch(e=>{console.err("取得使用者文檔出錯:",e)})}},getters:{collectionStatus(){return this.getUserAllCollection(),t=>this.coursesCollectionId.indexOf(t)>-1?"bookmark":"bookmark_border"}}});export{q as u};
