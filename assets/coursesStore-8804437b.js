import{d as y}from"./pinia-ef994b1a.js";import{g as A,S as h,n as g,h as m,e as i,d,u as w}from"./sweetalert2.all-6f07691f.js";import{t as I}from"./teacherStore-469df71a.js";import{u as S}from"./userStore-5da9acd5.js";const l=A(),p=I(),C=S(),D=h.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:1500,timerProgressBar:!0,didOpen:e=>{e.addEventListener("mouseenter",h.stopTimer),e.addEventListener("mouseleave",h.resumeTimer)}}),B=y("coursesStore",{state:()=>({isLoading:!0,isBought:null,AllCourseData:[],teacherNames:{},courseDetails:{data:{}},courseViewDetails:{data:{buyer:[],classMode:[],courseId:"",courseImg:"",courseIntro:"",location:"",name:"",price:0,startTime:0,teacherId:{},teacherImg:"",time:0,type:""},teacherImg:"",teacherName:"",teacherUid:""},popularCourses:[],suggestCourses:[]}),actions:{async getAllCourses(){const e=await g(m(l,"AllCourses"));this.AllCourseData=[],console.log("querySnapshot,",e),e.forEach(s=>{console.log(s.id," => ",s.data());const t={id:s.id,createdTime:s._document.createTime.timestamp.seconds,data:s.data()};this.AllCourseData.push(t)}),console.log("所有課程資料",this.AllCourseData)},async getAllCoursesAndTeacher(){this.isLoading=!0,this.AllCourseData=[];const e=await g(m(l,"AllCourses")),s=[];e.forEach(t=>{const o=t.data(),r=o.teacherId,a=i(r).then(c=>{if(c.exists()){const n=c.data().displayName;o.teacherName=n,this.teacherNames[o.teacherId]=n}else console.log(`老師 document ${o.teacherId} 不存在`)}).catch(c=>{console.error("老師 document fetching 錯誤",c)});s.push(a);const u={id:t.courseId,data:o};this.AllCourseData.push(u)}),await Promise.all(s),console.log("所有課程數據",this.AllCourseData),console.log("老師名稱",this.teacherNames),this.isLoading=!1},getBuyerCount(e){return e.data.buyer.length},async getPopularCourses(){this.popularCourses=[],await this.getAllCoursesAndTeacher(),console.log("購買人數排序前 - 購買人數",this.AllCourseData.map(e=>e.data.buyer.length)),console.log("購買人數排序前 - 課程名稱",this.AllCourseData.map(e=>e.data.name)),this.AllCourseData.sort((e,s)=>s.data.buyer.length-e.data.buyer.length),console.log("購買人數排序後 - 購買人數",this.AllCourseData.map(e=>e.data.buyer.length)),console.log("購買人數排序後 - 課程名稱",this.AllCourseData.map(e=>e.data.name)),this.popularCourses=this.AllCourseData.slice(0,10),console.log("暢銷課程前 10 名",this.popularCourses)},async getSuggestCourses(){this.isLoading=!0,this.suggestCourses=[],await this.getAllCoursesAndTeacher();const e=[];this.AllCourseData.forEach(t=>{t.data.type===this.courseDetails.data.type&&e.push(t)});const s=e.sort(()=>.5-Math.random());this.suggestCourses=s.slice(0,3),console.log("推薦課程",this.suggestCourses),this.isLoading=!1},async getCourseDetails(e){this.isLoading=!0;const s=d(l,"AllCourses",e),t=await i(s);if(t.exists()){const o=t.data(),r=o.teacherId,a=await i(r);if(a.exists()){const u=a.data().displayName,c=a.data().userIntro,n=a.data().userPhoto,f=a.data().uid;this.courseDetails={data:o,teacherName:u,teacherIntro:c,teacherImg:n,teacherUid:f},this.courseViewDetails=JSON.parse(JSON.stringify(this.courseDetails)),this.boughtCheck(e)}else console.log(`老師 document ${r.path} 不存在`)}else console.log(`課程 document ${e} 不存在`);console.log("單一課程資料",this.courseDetails),this.isLoading=!1},async updateCourseData(e){this.courseDetails.data.courseImg=p.teacherData.courseImg,await w(d(l,"AllCourses",e),this.courseDetails.data);try{p.teacherData.courseImg="",console.log("課程資料更新成功"),this.getCourseDetails(e),D.fire({icon:"success",title:"課程資料更新成功"})}catch(s){console.log("課程資料更新失敗",s),D.fire({icon:"error",title:"課程資料更新失敗"})}},async boughtCheck(e){await C.checkMemberObserver();const s=d(l,"users",C.uid);try{const t=await i(s);if(t.exists()){const o=await t.get("courses_joined"),r=await Promise.all(o.map(async a=>(await i(a)).data().courseId));console.log("courseArr",r),console.log("boughtCheck 的 courseId",e),r.includes(e)?(this.isBought=!0,console.log("存在 arr 中，已購買過")):(this.isBought=!1,console.log("不存在 arr 中，未購買過")),console.log("是否購買過",this.isBought)}else console.log("使用者 document 不存在(收藏)")}catch(t){console.error("沒有符合的課程:",t)}}},getters:{}});export{B as c};
